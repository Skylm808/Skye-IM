# Message å¾®æœåŠ¡æ¶æ„ä¸æµç¨‹è®²è§£

## ä¸€ã€æœåŠ¡æ¦‚è¿°

Message æœåŠ¡æ˜¯ SkyeIM å³æ—¶é€šè®¯ç³»ç»Ÿçš„**æ¶ˆæ¯ç®¡ç†å¾®æœåŠ¡**ï¼Œè´Ÿè´£ç§èŠæ¶ˆæ¯ã€ç¾¤èŠæ¶ˆæ¯çš„å­˜å‚¨ã€æŸ¥è¯¢ã€ç¦»çº¿åŒæ­¥ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç”¨é€” |
|------|---------|------|
| æ¡†æ¶ | go-zero | å¾®æœåŠ¡æ¡†æ¶ |
| æ•°æ®åº“ | MySQL | æ¶ˆæ¯æŒä¹…åŒ– |
| ç¼“å­˜ | Redis | ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—ã€å·²è¯»çŠ¶æ€ |
| é€šä¿¡ | gRPC + HTTP + WebSocket | å¤šåè®®æ”¯æŒ |
| æ¶ˆæ¯æ¨é€ | WebSocket | å®æ—¶æ¶ˆæ¯æ¨é€ |

---

## äºŒã€ç›®å½•ç»“æ„

```
app/message/
â”œâ”€â”€ api/                          # HTTP API å±‚
â”‚   â”œâ”€â”€ message.api               # API å®šä¹‰æ–‡ä»¶
â”‚   â”œâ”€â”€ MESSAGE_APIæ–‡æ¡£.md        # å‰ç«¯å¯¹æ¥æ–‡æ¡£
â”‚   â””â”€â”€ internal/
â”‚       â”œâ”€â”€ handler/              # HTTP å¤„ç†å™¨
â”‚       â””â”€â”€ logic/                # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ rpc/                          # gRPC æœåŠ¡å±‚
â”‚   â””â”€â”€ internal/
â”‚       â””â”€â”€ logic/                # RPC ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ model/                         # æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ im_message.sql            # æ¶ˆæ¯è¡¨ DDL
â”‚   â””â”€â”€ *.go                      # Model å®ç°
â””â”€â”€ README.md                      # æœåŠ¡è¯´æ˜
```

---

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ¶ˆæ¯è¡¨ (im_message)

```sql
CREATE TABLE IF NOT EXISTS `im_message` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `msg_id` VARCHAR(64) NOT NULL COMMENT 'æ¶ˆæ¯å”¯ä¸€æ ‡è¯†',
    `from_user_id` BIGINT UNSIGNED NOT NULL COMMENT 'å‘é€è€…ID',
    `to_user_id` BIGINT UNSIGNED DEFAULT 0 COMMENT 'æ¥æ”¶è€…ID(ç§èŠæ—¶æœ‰æ•ˆ)',
    `chat_type` TINYINT NOT NULL DEFAULT 1 COMMENT 'èŠå¤©ç±»å‹: 1-ç§èŠ 2-ç¾¤èŠ',
    `group_id` VARCHAR(64) DEFAULT NULL COMMENT 'ç¾¤ç»„ID(ç¾¤èŠæ—¶ä½¿ç”¨)',
    `seq` BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æ¶ˆæ¯åºåˆ—å·(ç¾¤èŠä½¿ç”¨)',
    `content` TEXT NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
    `content_type` TINYINT NOT NULL DEFAULT 1 COMMENT 'æ¶ˆæ¯å†…å®¹ç±»å‹: 1-æ–‡å­— 2-å›¾ç‰‡ 3-æ–‡ä»¶ 4-è¯­éŸ³',
    `status` TINYINT NOT NULL DEFAULT 0 COMMENT 'æ¶ˆæ¯çŠ¶æ€: 0-æœªè¯» 1-å·²è¯» 2-æ’¤å›',
    `at_user_ids` TEXT COMMENT 'è¢«@çš„ç”¨æˆ·IDåˆ—è¡¨',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `idx_msg_id` (`msg_id`),
    KEY `idx_from_user` (`from_user_id`),
    KEY `idx_to_user` (`to_user_id`),
    KEY `idx_group_id` (`group_id`),
    KEY `idx_conversation` (`from_user_id`, `to_user_id`, `created_at`),
    KEY `idx_unread` (`to_user_id`, `status`, `created_at`),
    KEY `idx_group_seq` (`group_id`, `seq`),
    KEY `idx_at_users` (`group_id`, `chat_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**è®¾è®¡è¦ç‚¹**ï¼š

**1. ç§èŠå’Œç¾¤èŠç»Ÿä¸€è¡¨**:
- `chat_type=1`: ç§èŠï¼Œä½¿ç”¨ `to_user_id`
- `chat_type=2`: ç¾¤èŠï¼Œä½¿ç”¨  `group_id`

**ä¼˜ç‚¹**: 
- âœ… ç®€åŒ–æ¶æ„ï¼Œå‡å°‘è¡¨æ•°é‡
- âœ… ä¾¿äºç»Ÿä¸€æœç´¢å’Œç®¡ç†

**ç¼ºç‚¹**:
- âŒ ç¾¤èŠè¡¨æ•°æ®é‡å¤§ï¼ˆéœ€è¦åˆ†è¡¨ï¼‰

**2. æ¶ˆæ¯ ID è®¾è®¡**:
```
msg_id: å…¨å±€å”¯ä¸€ï¼ˆå®¢æˆ·ç«¯ç”Ÿæˆæˆ–é›ªèŠ±ç®—æ³•ï¼‰
id: æ•°æ®åº“è‡ªå¢ä¸»é”®ï¼ˆç”¨äºåˆ†é¡µï¼‰
```

**3. Seq åºåˆ—å·ï¼ˆä»…ç¾¤èŠï¼‰**:
- ç¾¤å†…æ¶ˆæ¯é€’å¢åºåˆ—å·
- ç”¨äºç¦»çº¿åŒæ­¥å’Œå·²è¯»è¿›åº¦
- æ¯ä¸ªç¾¤ç‹¬ç«‹è®¡æ•°

**4. @åŠŸèƒ½æ”¯æŒ**:
- `at_user_ids`: JSON æ•°ç»„ `["123", "456"]`
- `-1` è¡¨ç¤º@å…¨ä½“æˆå‘˜

**5. ç´¢å¼•ä¼˜åŒ–**:
| ç´¢å¼• | ç”¨é€” |
|------|------|
| `idx_conversation` | æŸ¥è¯¢ä¸¤äººèŠå¤©è®°å½• |
| `idx_unread` | æŸ¥è¯¢æœªè¯»æ¶ˆæ¯ |
| `idx_group_seq` | ç¾¤èŠç¦»çº¿åŒæ­¥ |
| `idx_at_users` | æŸ¥è¯¢@æˆ‘çš„æ¶ˆæ¯ |

---

## å››ã€æ ¸å¿ƒæµç¨‹

### 4.1 å‘é€ç§èŠæ¶ˆæ¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket å‘é€æ¶ˆæ¯    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ WebSocket    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  {toUserId, content}      â”‚ æœåŠ¡ (10300) â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚ è°ƒç”¨ RPC
                                               â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ Message RPC  â”‚
                                        â”‚ SendMessage  â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                               â”‚              â”‚
                â–¼                               â–¼              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æ£€æŸ¥å¥½å‹å…³ç³»â”‚              â”‚ æ’å…¥æ¶ˆæ¯    â”‚ â”‚ æ¨é€ç»™æ¥æ”¶è€…â”‚
         â”‚ Friend RPC  â”‚              â”‚ im_message  â”‚ â”‚ WebSocket   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                              â”‚
                â”‚ æ˜¯å¥½å‹                                       â”‚
                â–¼                                              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ç”Ÿæˆ msg_id â”‚                              â”‚ åœ¨çº¿ï¼šæ¨é€  â”‚
         â”‚ ç”Ÿæˆæ—¶é—´æˆ³  â”‚                              â”‚ ç¦»çº¿ï¼šç¼“å­˜  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®é€»è¾‘**ï¼š
1. **å¥½å‹éªŒè¯**: è°ƒç”¨ Friend RPC æ£€æŸ¥æ˜¯å¦ä¸ºå¥½å‹
2. **æ¶ˆæ¯å­˜å‚¨**: æ’å…¥ `im_message`ï¼Œstatus=0ï¼ˆæœªè¯»ï¼‰
3. **å®æ—¶æ¨é€**: 
   - æ¥æ”¶è€…**åœ¨çº¿** â†’ WebSocket ç«‹å³æ¨é€
   - æ¥æ”¶è€…**ç¦»çº¿** â†’ ç¼“å­˜åˆ° Redis ç¦»çº¿é˜Ÿåˆ—

---

### 4.2 å‘é€ç¾¤èŠæ¶ˆæ¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket å‘é€ç¾¤æ¶ˆæ¯    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ WebSocket    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  {groupId, content, at}    â”‚ æœåŠ¡         â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚ è°ƒç”¨ RPC
                                                â–¼
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ Message RPC  â”‚
                                         â”‚ SendGroup    â”‚
                                         â”‚ Message      â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                â”‚              â”‚
                â–¼                                â–¼              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æ£€æŸ¥ç¾¤æˆå‘˜  â”‚              â”‚ ç”Ÿæˆ Seq    â”‚ â”‚ æ’å…¥æ¶ˆæ¯    â”‚
         â”‚ Group RPC   â”‚              â”‚ (Redis)     â”‚ â”‚ im_message  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                              â”‚
                â”‚ æ˜¯æˆå‘˜ä¸”æœªç¦è¨€                â”‚ seq + 1
                â–¼                              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ è·å–åœ¨çº¿æˆå‘˜â”‚              â”‚ ä¿å­˜ at_userâ”‚
         â”‚   åˆ—è¡¨      â”‚              â”‚    _ids     â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ WebSocket æ¨é€ç»™    â”‚
         â”‚   æ‰€æœ‰åœ¨çº¿æˆå‘˜      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**ï¼š
1. **ç¾¤æˆå‘˜éªŒè¯**: è°ƒç”¨ Group RPC æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤æˆå‘˜
2. **ç¦è¨€æ£€æŸ¥**: æ£€æŸ¥æ˜¯å¦è¢«ç¦è¨€
3. **Seq ç”Ÿæˆ**: Redis è‡ªå¢ï¼Œä¿è¯ç¾¤å†…æ¶ˆæ¯é¡ºåº
4. **@æƒé™æ ¡éªŒ**: @å…¨ä½“æˆå‘˜éœ€è¦ç®¡ç†å‘˜æƒé™
5. **æ‰¹é‡æ¨é€**: æ¨é€ç»™ç¾¤å†…æ‰€æœ‰åœ¨çº¿æˆå‘˜

---

### 4.3 ç¦»çº¿æ¶ˆæ¯åŒæ­¥æµç¨‹

**ç§èŠç¦»çº¿åŒæ­¥**ï¼š
```
ç”¨æˆ·ä¸Šçº¿ï¼ˆWebSocket è¿æ¥ï¼‰
    â†“
WebSocket è‡ªåŠ¨æ¨é€
ä» Redis ç¦»çº¿é˜Ÿåˆ—è·å–å‰ 20 æ¡
    â†“
å¦‚æœç¦»çº¿æ¶ˆæ¯ > 20 æ¡
    â†“
å‰ç«¯è°ƒç”¨ HTTP API
GET /api/v1/message/offline?skip=20&limit=100
    â†“
æŸ¥è¯¢æ•°æ®åº“
WHERE to_user_id = ? AND status = 0
ORDER BY id DESC
LIMIT 100 OFFSET 20
    â†“
è¿”å›å‰©ä½™ç¦»çº¿æ¶ˆæ¯
```

**ç¾¤èŠç¦»çº¿åŒæ­¥**ï¼š
```
ç”¨æˆ·ä¸Šçº¿
    â†“
æŸ¥è¯¢æ¯ä¸ªç¾¤çš„ readSeq
ä» im_group_member è¡¨
    â†“
è°ƒç”¨ç¦»çº¿åŒæ­¥æ¥å£
GET /api/v1/message/group/sync?groupId=g1&seq=1200
    â†“
æŸ¥è¯¢æ•°æ®åº“
WHERE group_id = ? AND seq > 1200
ORDER BY seq ASC
    â†“
è¿”å›ç¦»çº¿ç¾¤æ¶ˆæ¯
```

---

### 4.4 å·²è¯»æœºåˆ¶

**ç§èŠå·²è¯»**ï¼š
```
ç”¨æˆ·é˜…è¯»æ¶ˆæ¯
    â†“
å‰ç«¯æ‰¹é‡ä¸ŠæŠ¥å·²è¯»
POST /api/v1/message/read
{peerId: 1002, msgIds: ["msg_xxx", ...]}
    â†“
æ›´æ–°æ•°æ®åº“
UPDATE im_message
SET status = 1
WHERE msg_id IN (...)
  AND to_user_id = å½“å‰ç”¨æˆ·
    â†“
WebSocket æ¨é€å·²è¯»å›æ‰§ç»™å‘é€è€…
```

**ç¾¤èŠå·²è¯»**ï¼š
```
ç”¨æˆ·é˜…è¯»ç¾¤æ¶ˆæ¯
    â†“
å‰ç«¯ä¸ŠæŠ¥å·²è¯» Seq
POST /api/v1/message/group/read
{groupId: "g1", readSeq: 1250}
    â†“
æ›´æ–° im_group_member è¡¨
UPDATE im_group_member
SET read_seq = 1250
WHERE group_id = ? AND user_id = ?
    â†“
æœªè¯»æ•°è®¡ç®—
æœªè¯» = ç¾¤æœ€æ–°Seq - readSeq
```

---

## äº”ã€æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 5.1 æ¶ˆæ¯ ID ç”Ÿæˆç­–ç•¥

**æ–¹æ¡ˆä¸€ï¼šå®¢æˆ·ç«¯ç”Ÿæˆï¼ˆUUIDï¼‰**:
```go
msgId := uuid.New().String()
// ä¾‹å¦‚: "550e8400-e29b-41d4-a716-446655440000"
```
**ä¼˜ç‚¹**: 
- âœ… åˆ†å¸ƒå¼ç¯å¢ƒæ— å†²çª
- âœ… å®¢æˆ·ç«¯å¯ä»¥æå‰ç”Ÿæˆï¼Œä¼˜åŒ–ä½“éªŒ

**æ–¹æ¡ˆäºŒï¼šæœåŠ¡ç«¯ç”Ÿæˆï¼ˆé›ªèŠ±ç®—æ³•ï¼‰**:
```go
msgId := snowflake.Generate()
// ä¾‹å¦‚: "1234567890123456789"
```
**ä¼˜ç‚¹**:
- âœ… æœ‰åºã€é€’å¢
- âœ… å¯ä»¥ä» ID è§£ææ—¶é—´æˆ³

**å½“å‰å®ç°**: æ–¹æ¡ˆä¸€ï¼ˆUUIDï¼‰ï¼Œç”±å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯ç”Ÿæˆ

---

### 5.2 ç¾¤èŠ Seq ç”Ÿæˆ

**å®ç°**ï¼šRedis è‡ªå¢
```go
func GenerateGroupSeq(groupId string) uint64 {
    key := fmt.Sprintf("group:seq:%s", groupId)
    seq := redis.Incr(key)
    return seq
}
```

**ä¸ºä»€ä¹ˆä¸ç”¨æ•°æ®åº“è‡ªå¢**ï¼Ÿ
- âŒ æ•°æ®åº“è‡ªå¢æ— æ³•ä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ€§èƒ½
- âœ… Redis è‡ªå¢æ€§èƒ½é«˜ï¼Œå•çº¿ç¨‹ä¿è¯åŸå­æ€§

**Seq ç”¨é€”**ï¼š
1. **ç¦»çº¿åŒæ­¥**: æ‹‰å– `seq > lastSeq` çš„æ¶ˆæ¯
2. **å·²è¯»è¿›åº¦**: `readSeq` è¡¨ç¤ºå·²è¯»åˆ°å“ªæ¡æ¶ˆæ¯
3. **æœªè¯»è®¡æ•°**: `æœ€æ–°Seq - readSeq`

---

### 5.3 @åŠŸèƒ½å®ç°

**æ•°æ®ç»“æ„**:
```sql
at_user_ids TEXT  -- JSON: ["1001", "1002"] æˆ– ["-1"]
```

**@å…¨ä½“æˆå‘˜**:
```json
{
  "atUserIds": [-1]
}
```

**æƒé™æ ¡éªŒ**:
```go
func CanAtAll(groupId string, userId int64) bool {
    member := groupRpc.GetMember(groupId, userId)
    // åªæœ‰ç¾¤ä¸»å’Œç®¡ç†å‘˜å¯ä»¥@å…¨ä½“
    return member.Role == 1 || member.Role == 2
}
```

**æŸ¥è¯¢@æˆ‘çš„æ¶ˆæ¯**:
```sql
SELECT * FROM im_message
WHERE group_id = ?
  AND (
    FIND_IN_SET(?, at_user_ids) > 0  -- @æˆ‘
    OR FIND_IN_SET(-1, at_user_ids) > 0  -- @å…¨ä½“
  )
ORDER BY id DESC;
```

---

### 5.4 ç¦»çº¿æ¶ˆæ¯å­˜å‚¨

**ç§èŠç¦»çº¿æ¶ˆæ¯**:
```
Redis List:
Key: offline:private:{userId}
Value: [æ¶ˆæ¯1, æ¶ˆæ¯2, ...]
TTL: 7å¤©
```

**ç¾¤èŠç¦»çº¿æ¶ˆæ¯**:
- ä¸ç¼“å­˜åˆ° Redisï¼ˆæ•°æ®é‡å¤ªå¤§ï¼‰
- ç›´æ¥é€šè¿‡ Seq æœºåˆ¶ä»æ•°æ®åº“æ‹‰å–

**ä¸ºä»€ä¹ˆç§èŠç”¨ Redisï¼Ÿ**
- âœ… å¿«é€Ÿæ¨é€ï¼šç”¨æˆ·ä¸Šçº¿ç«‹å³æ¨é€
- âœ… å‡å°‘æ•°æ®åº“å‹åŠ›
- âŒ å†…å­˜å ç”¨ï¼šéœ€è¦è®¾ç½® TTL

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 6.1 æ•°æ®åº“ä¼˜åŒ–

**1. ç´¢å¼•ä¼˜åŒ–**:
```sql
-- æŸ¥è¯¢ä¼šè¯æ¶ˆæ¯
KEY `idx_conversation` (`from_user_id`, `to_user_id`, `created_at`)

-- æŸ¥è¯¢æœªè¯»æ¶ˆæ¯
KEY `idx_unread` (`to_user_id`, `status`, `created_at`)

-- ç¾¤èŠç¦»çº¿åŒæ­¥
KEY `idx_group_seq` (`group_id`, `seq`)
```

**2. åˆ†é¡µæŸ¥è¯¢**:
```go
// ä½¿ç”¨ lastMsgId åˆ†é¡µï¼Œé¿å… OFFSET
SELECT * FROM im_message
WHERE ... AND id < ?  -- lastMsgId
ORDER BY id DESC
LIMIT 20;
```

**3. åˆ†è¡¨ç­–ç•¥**ï¼ˆæ•°æ®é‡å¤§æ—¶ï¼‰:
```
im_message_0  -- id % 10 = 0
im_message_1  -- id % 10 = 1
...
im_message_9  -- id % 10 = 9
```

---

### 6.2 ç¼“å­˜ä¼˜åŒ–

**1. ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—**:
- ç§èŠç¦»çº¿æ¶ˆæ¯ç¼“å­˜åˆ° Redis
- WebSocket è¿æ¥æ—¶å¿«é€Ÿæ¨é€

**2. Seq ç¼“å­˜**:
- ç¾¤æœ€æ–° Seq ç¼“å­˜åˆ° Redis
- é¿å…æ¯æ¬¡æŸ¥è¯¢æ•°æ®åº“

**3. å·²è¯»çŠ¶æ€ç¼“å­˜**:
- æ‰¹é‡æ›´æ–°å·²è¯»çŠ¶æ€
- å…ˆæ›´æ–° Redisï¼Œå®šæ—¶å†™å…¥æ•°æ®åº“

---

### 6.3 æ¨é€ä¼˜åŒ–

**1. ç¾¤èŠæ¨é€**:
```go
// åªæ¨é€ç»™åœ¨çº¿æˆå‘˜
onlineMembers := getOnlineMembersFromRedis(groupId)
for _, member := range onlineMembers {
    wsClient.Push(member.UserId, message)
}
```

**2. æ‰¹é‡æ¨é€**:
```go
// æ‰¹é‡æ¨é€ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
messages := collectMessages()
wsClient.BatchPush(userIds, messages)
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆç§èŠå’Œç¾¤èŠç”¨åŒä¸€å¼ è¡¨ï¼Ÿ

**A**: 
- **ä¼˜ç‚¹**: ç®€åŒ–æ¶æ„ï¼Œä¾¿äºç»Ÿä¸€æœç´¢
- **ç¼ºç‚¹**: è¡¨æ•°æ®é‡å¤§ï¼Œéœ€è¦åˆ†è¡¨
- **æ›¿ä»£æ–¹æ¡ˆ**: ç§èŠå’Œç¾¤èŠåˆ†è¡¨ï¼Œä½†éœ€è¦ä¸¤å¥—é€»è¾‘

é€‰æ‹©ç»Ÿä¸€è¡¨æ˜¯å› ä¸ºå½“å‰è§„æ¨¡ä¸‹ä¼˜ç‚¹å¤§äºç¼ºç‚¹ã€‚

---

### Q2: ç¾¤èŠ Seq æ–­äº†æ€ä¹ˆåŠï¼Ÿ

**A**: Seq ç”± Redis è‡ªå¢ç”Ÿæˆï¼Œç†è®ºä¸Šä¸ä¼šæ–­ã€‚å¦‚æœ Redis æ•°æ®ä¸¢å¤±ï¼š
1. ä»æ•°æ®åº“æŸ¥è¯¢è¯¥ç¾¤æœ€å¤§ Seq
2. é‡æ–°åˆå§‹åŒ– Redis

---

### Q3: æ¶ˆæ¯å·²è¯»çŠ¶æ€å¦‚ä½•å®æ—¶åŒæ­¥ï¼Ÿ

**A**: 
1. ç”¨æˆ· A é˜…è¯»æ¶ˆæ¯åè°ƒç”¨ `/read` æ¥å£
2. åç«¯æ›´æ–°æ•°æ®åº“
3. WebSocket æ¨é€å·²è¯»å›æ‰§ç»™å‘é€è€… B
4. B çš„å‰ç«¯æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸º"å·²è¯»"

---

### Q4: å¦‚ä½•å®ç°æ¶ˆæ¯æ’¤å›ï¼Ÿ

**A**: å½“å‰æœªå®ç°ï¼Œå¦‚éœ€å®ç°ï¼š
```go
POST /api/v1/message/recall
Body: {msgId}

// åç«¯é€»è¾‘
UPDATE im_message SET status = 2 WHERE msg_id = ?

// WebSocket æ¨é€æ’¤å›é€šçŸ¥
wsClient.Push(peerId, {
    type: "recall",
    msgId: msgId
})
```

---

## å…«ã€æ€»ç»“

Message å¾®æœåŠ¡é‡‡ç”¨**åˆ†å±‚æ¶æ„**ï¼š

1. **API å±‚**ï¼šHTTP æ¥å£ï¼ˆå†å²ã€ç¦»çº¿åŒæ­¥ï¼‰
2. **WebSocket å±‚**ï¼šå®æ—¶æ”¶å‘æ¶ˆæ¯
3. **RPC å±‚**ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
4. **Model å±‚**ï¼šæ•°æ®è®¿é—®ï¼ˆå¸¦ç¼“å­˜ï¼‰

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ğŸ“Š ç§èŠå’Œç¾¤èŠç»Ÿä¸€è¡¨è®¾è®¡
- ğŸš€ WebSocket å®æ—¶æ¨é€
- ğŸ“– Seq æœºåˆ¶æ”¯æŒç¦»çº¿åŒæ­¥
- ğŸ’¾ Redis ç¼“å­˜ç¦»çº¿æ¶ˆæ¯
- ğŸ“¢ @åŠŸèƒ½æ”¯æŒ
- ğŸ¯ æ€§èƒ½ä¼˜åŒ–ï¼ˆç´¢å¼•ã€åˆ†é¡µã€ç¼“å­˜ï¼‰

---

**æ–‡æ¡£ä½œè€…**: Skylm  
**æœ€åæ›´æ–°**: 2026-01-13  
**ç›¸å…³æ–‡æ¡£**: [Message API æ–‡æ¡£](./api/MESSAGE_APIæ–‡æ¡£.md)
